#include <assert.h>
#include <stdlib.h>

#include "lgpng.h"

uint8_t ihdr_basn0g01[25] = {
	0x00, 0x00, 0x00, 0x0d,
	0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x20,
	0x00, 0x00, 0x00, 0x20,
	0x01, 0x00, 0x00, 0x00,
	0x00,
	0x5b, 0x01, 0x47, 0x59
};

uint8_t ihdr_basn0g02[25] = {
	0x00, 0x00, 0x00, 0x0d,
	0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x20,
	0x00, 0x00, 0x00, 0x20,
	0x02, 0x00, 0x00, 0x00,
	0x00,
	0x5b, 0x01, 0x47, 0x59
};

uint8_t ihdr_basn0g04[25] = {
	0x00, 0x00, 0x00, 0x0d,
	0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x20,
	0x00, 0x00, 0x00, 0x20,
	0x04, 0x00, 0x00, 0x00,
	0x00,
	0x5b, 0x01, 0x47, 0x59
};

uint8_t ihdr_basn0g08[25] = {
	0x00, 0x00, 0x00, 0x0d,
	0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x20,
	0x00, 0x00, 0x00, 0x20,
	0x08, 0x00, 0x00, 0x00,
	0x00,
	0x5b, 0x01, 0x47, 0x59
};

uint8_t ihdr_basn0g16[25] = {
	0x00, 0x00, 0x00, 0x0d,
	0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x20,
	0x00, 0x00, 0x00, 0x20,
	0x10, 0x00, 0x00, 0x00,
	0x00,
	0x5b, 0x01, 0x47, 0x59
};

uint8_t ihdr_basn2c08[25] = {
	0x00, 0x00, 0x00, 0x0d,
	0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x20,
	0x00, 0x00, 0x00, 0x20,
	0x08, 0x02, 0x00, 0x00,
	0x00,
	0xfc, 0x18, 0xed, 0xa3
};

uint8_t ihdr_basn2c16[25] = {
	0x00, 0x00, 0x00, 0x0d,
	0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x20,
	0x00, 0x00, 0x00, 0x20,
	0x10, 0x02, 0x00, 0x00,
	0x00,
	0xfc, 0x18, 0xed, 0xa3
};

uint8_t ihdr_basn3p01[25] = {
	0x00, 0x00, 0x00, 0x0d,
	0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x20,
	0x00, 0x00, 0x00, 0x20,
	0x01, 0x03, 0x00, 0x00,
	0x00,
	0x49, 0xb4, 0xe8, 0xb7
};

uint8_t ihdr_basn3p02[25] = {
	0x00, 0x00, 0x00, 0x0d,
	0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x20,
	0x00, 0x00, 0x00, 0x20,
	0x02, 0x03, 0x00, 0x00,
	0x00,
	0x49, 0xb4, 0xe8, 0xb7
};

uint8_t ihdr_basn3p04[25] = {
	0x00, 0x00, 0x00, 0x0d,
	0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x20,
	0x00, 0x00, 0x00, 0x20,
	0x04, 0x03, 0x00, 0x00,
	0x00,
	0x49, 0xb4, 0xe8, 0xb7
};

uint8_t ihdr_basn3p08[25] = {
	0x00, 0x00, 0x00, 0x0d,
	0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x20,
	0x00, 0x00, 0x00, 0x20,
	0x08, 0x03, 0x00, 0x00,
	0x00,
	0x49, 0xb4, 0xe8, 0xb7
};

uint8_t ihdr_basn4a08[25] = {
	0x00, 0x00, 0x00, 0x0d,
	0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x20,
	0x00, 0x00, 0x00, 0x20,
	0x08, 0x04, 0x00, 0x00,
	0x00,
	0xd9, 0x73, 0xb2, 0x7f
};

uint8_t ihdr_basn4a16[25] = {
	0x00, 0x00, 0x00, 0x0d,
	0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x20,
	0x00, 0x00, 0x00, 0x20,
	0x10, 0x04, 0x00, 0x00,
	0x00,
	0xd9, 0x73, 0xb2, 0x7f
};

uint8_t ihdr_basn6a08[25] = {
	0x00, 0x00, 0x00, 0x0d,
	0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x20,
	0x00, 0x00, 0x00, 0x20,
	0x08, 0x06, 0x00, 0x00,
	0x00,
	0xd9, 0x73, 0xb2, 0x7f
};

uint8_t ihdr_basn6a16[25] = {
	0x00, 0x00, 0x00, 0x0d,
	0x49, 0x48, 0x44, 0x52,
	0x00, 0x00, 0x00, 0x20,
	0x00, 0x00, 0x00, 0x20,
	0x10, 0x06, 0x00, 0x00,
	0x00,
	0xd9, 0x73, 0xb2, 0x7f
};

void
test_ihdr(char *title, int testnum, uint8_t *source,
    uint32_t width, uint32_t height, int bitdepth, int colourtype, int comp, int filter, int inter)
{
	struct IHDR		 ihdr;
	struct unknown_chunk	 uchunk;
	uint8_t			*data;

	lgpng_get_next_chunk_from_bytes((uint8_t *)source, &uchunk, &data);
	if (-1 == lgpng_create_IHDR_from_data(&ihdr, data, uchunk.length)) {
		printf("not ok %d - %s (chunk)\n", testnum, title);
	} else {
		if (width != ihdr.data.width) {
			printf("not ok %d - %s (width)\n", testnum, title);
		} else if (height != ihdr.data.height) {
			printf("not ok %d - %s (height)\n", testnum, title);
		} else if (bitdepth != ihdr.data.bitdepth) {
			printf("not ok %d - %s (bit depth)\n", testnum, title);
		} else if (colourtype != ihdr.data.colourtype) {
			printf("not ok %d - %s (colour type %d)\n", testnum, title, ihdr.data.colourtype);
		} else if (comp != ihdr.data.compression) {
			printf("not ok %d - %s (compression)\n", testnum, title);
		} else if (filter != ihdr.data.filter) {
			printf("not ok %d - %s (filter)\n", testnum, title);
		} else if (inter != ihdr.data.interlace) {
			printf("not ok %d - %s (interlace)\n", testnum, title);
		} else {
			printf("ok %d - %s\n", testnum, title);
		}
	}
	free(data);
	data = NULL;
}

#define TEST_IHDR_GRAY(title, testnum, source, bitdepth) \
	test_ihdr(title, testnum, source, 32, 32, bitdepth, COLOUR_TYPE_GREYSCALE, COMPRESSION_TYPE_DEFLATE, FILTER_METHOD_ADAPTIVE, INTERLACE_METHOD_STANDARD)
#define TEST_IHDR_TRUECOLOUR(title, testnum, source, bitdepth) \
	test_ihdr(title, testnum, source, 32, 32, bitdepth, COLOUR_TYPE_TRUECOLOUR, COMPRESSION_TYPE_DEFLATE, FILTER_METHOD_ADAPTIVE, INTERLACE_METHOD_STANDARD)
#define TEST_IHDR_PALETTE(title, testnum, source, bitdepth) \
	test_ihdr(title, testnum, source, 32, 32, bitdepth, COLOUR_TYPE_INDEXED, COMPRESSION_TYPE_DEFLATE, FILTER_METHOD_ADAPTIVE, INTERLACE_METHOD_STANDARD)
#define TEST_IHDR_GRAY_ALPHA(title, testnum, source, bitdepth) \
	test_ihdr(title, testnum, source, 32, 32, bitdepth, COLOUR_TYPE_GREYSCALE_ALPHA, COMPRESSION_TYPE_DEFLATE, FILTER_METHOD_ADAPTIVE, INTERLACE_METHOD_STANDARD)
#define TEST_IHDR_TRUECOLOUR_ALPHA(title, testnum, source, bitdepth) \
	test_ihdr(title, testnum, source, 32, 32, bitdepth, COLOUR_TYPE_TRUECOLOUR_ALPHA, COMPRESSION_TYPE_DEFLATE, FILTER_METHOD_ADAPTIVE, INTERLACE_METHOD_STANDARD)

int
main(void)
{
	int testnum = 1;

	printf("IHDR tests");
	printf("TAP version 13\n");
	printf("1..1\n");
	TEST_IHDR_GRAY("Black and white", testnum++, ihdr_basn0g01, 1);
	TEST_IHDR_GRAY("2-bit grayscale", testnum++, ihdr_basn0g02, 2);
	TEST_IHDR_GRAY("4-bit grayscale", testnum++, ihdr_basn0g04, 4);
	TEST_IHDR_GRAY("8-bit grayscale", testnum++, ihdr_basn0g08, 8);
	TEST_IHDR_GRAY("16-bit grayscale", testnum++, ihdr_basn0g16, 16);
	TEST_IHDR_TRUECOLOUR("8-bit colour", testnum++, ihdr_basn2c08, 8);
	TEST_IHDR_TRUECOLOUR("16-bit colour", testnum++, ihdr_basn2c16, 16);
	TEST_IHDR_PALETTE("1-bit palette", testnum++, ihdr_basn3p01, 1);
	TEST_IHDR_PALETTE("2-bit palette", testnum++, ihdr_basn3p02, 2);
	TEST_IHDR_PALETTE("4-bit palette", testnum++, ihdr_basn3p04, 4);
	TEST_IHDR_PALETTE("8-bit palette", testnum++, ihdr_basn3p08, 8);
	TEST_IHDR_GRAY_ALPHA("8-bit grayscale + alpha", testnum++, ihdr_basn4a08, 8);
	TEST_IHDR_GRAY_ALPHA("16-bit grayscale + alpha", testnum++, ihdr_basn4a16, 16);
	TEST_IHDR_TRUECOLOUR_ALPHA("8-bit colour + alpha", testnum++, ihdr_basn6a08, 8);
	TEST_IHDR_TRUECOLOUR_ALPHA("16-bit colour + alpha", testnum++, ihdr_basn6a16, 16);

	return(0);
}

